title: 深入理解tcp协议
date: 2015-08-24 22:54:00
categories: blog
tags: [front-end,计算机网络]
---
##TCP协议
今天和屌哥深入理解探讨了一下tcp协议，真的非常有意思！

TCP的传输是面向字节流的，但是它的传送的数据单元确是<b>报文段</b>。  其中的报文段理解透了就能掌握TCP的工作原理。

<!-- more -->
报文段如图

![](http://7xklhg.com1.z0.glb.clouddn.com/gitcafe_tcp.gif)

其中理解的重点就是序号[seq]、确认号[ack]、以及6个控制位中的确认ACK,推送PSH(Push)、复位（Reset）、同步SYN、终止FIN等状态，还有就是窗口。

<b>序号</b>：本报文段所发送的数据的第一个字节的序号。  
<b>确认号ack</b>：期待收到对方下一个报文段的第一个数据字节的序号。   
<b>确认ACK</b>：占1位，仅当ACK=1时，确认号字段才有效。ACK=0时，确认号无效。   
<b>同步SYN</b>：连接建立时用于同步序号。当SYN=1，ACK=0时表示：这是一个连接请求报文段。   
若同意连接，则在响应报文段中使得SYN=1，ACK=1。因此，SYN=1表示这是一个连接请求，或连接接受报文。   
<b>终止FIN</b>：用来释放一个连接。FIN=1表示：此报文段的发送方的数据已经发送完毕，并要求释放运输连接。


###TCP运输
运输分为3个阶段

*  建立连接
*  数据传送
*  连接释放

而建立连接，就是我们说的TCP连接处理的问题就是

1、每方都需要知道对方的存在  
2、允许双方协议一些参数（最大窗口值）   
3、能对运输实体匹配


####连接建立

![](http://7xklhg.com1.z0.glb.clouddn.com/gitcafe_tcp_connet.png)

B的TCP服务器先建立TCB(传送控制块：存储了每个连接的重要信息，如TCP连接表，当前的发送和接受序号)

<b>第一次连接</b>：客户端A建立传送控制块TCB，向B发出请求。[控制位状态：同部位SYN=1,初始序号seq=x]

<b>第二次连接</b>：B服务端若同意建立则向A发送确认。[控制位状态：同部位SYN=1,确认ACK=1,初始序号seq=y,ack=x+1]


<b>第三次连接</b>：客户端A给出确认，TCP连接。[控制位状态：确认ACK=1,初始序号seq=x+1,ack=y+1]

<b>第三次连接的目的</b>：防止已失效的连接请求报文段突然又传到了B，因而产生错误。



####连接释放

![](http://7xklhg.com1.z0.glb.clouddn.com/gitcafe_tcp_disconnet.png)


B收到连接释放报文段后就立即发送确认，然后就进入close-wait状态，此时TCP服务器进程就通知高层应用进程.     因而从A到B的连接就释放了,

此时是“半关闭”状态。即A不可以发送给B，但是B可以发送给A。若B没有数据报要发送给A了，其应用进程就通知TCP释放连接，然后发送给A连接释放报文段，并等待确认。
A发送确认后，进入time-wait。
   

再经过时间等待计时器设置的<b>2MSL</b>后，这样这段连接持续的时间内所产生的报文都会消失，才进入到close状态。


<b>2MSL目的</b>：

*  为了保证A发送的最后一个ACK报文段能够到达B。
*  防止“已失效的连接请求报文段”出现在连接中


学习资料：《计算机网络》